<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Create your own adventure">
    <meta name="author" content="Matthew Gold">
    <link rel="shortcut icon" href="Images/favicon.ico">

    <title>Adventure Engine</title>

    <!-- Bootstrap core CSS -->
    <link href="CSS/bootswatch/bootstrap.readable.min.css" rel="stylesheet" media="screen" title="main">
	<link href="CSS/bootstrap-switch.min.css" rel="stylesheet">
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="CSS/template.css" rel="stylesheet">
	<link href="CSS/treeview.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body>

    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="AdventureEngine.html">Adventure Engine</a>
            </div>
            <div class="collapse navbar-collapse">
                <ul class="nav navbar-nav">
                    <li class="active"><a href="#">Home</a></li>
					
					<li><a href="javascript:exportStory();">Export</a></li>
                    <li class="dropdown">
                      <a class="dropdown-toggle" data-toggle="dropdown" href="#" id="download">Theme <span class="caret"></span></a>
                      <ul class="dropdown-menu" aria-labelledby="download">
					      <li><a href="#" class="change-style-menu-item" rel="CSS/bootswatch/bootstrap.readable.min.css"><i class="icon-fixed-width icon-pencil"></i> Readable (Default)</a></li>
                          <li><a href="#" class="change-style-menu-item" rel="CSS/bootstrap.min.css"><i class="icon-fixed-width icon-pencil"></i> Bootstrap (No Theme)</a></li>
                          <li class="divider"></li>
                          <li role="presentation" class="dropdown-header">Light Color Schemes</li>
                          <!--<li><a href="#" class="change-style-menu-item" rel="CSS/bootswatch/bootstrap.amelia.min.css"><i class="icon-fixed-width icon-pencil"></i> Amelia</a></li>-->
                          <li><a href="#" class="change-style-menu-item" rel="CSS/bootswatch/bootstrap.cerulean.min.css"><i class="icon-fixed-width icon-pencil"></i> Cerulean</a></li>
                          <li><a href="#" class="change-style-menu-item" rel="CSS/bootswatch/bootstrap.cosmo.min.css"><i class="icon-fixed-width icon-pencil"></i> Cosmo</a></li>
                          <li><a href="#" class="change-style-menu-item" rel="CSS/bootswatch/bootstrap.flatly.min.css"><i class="icon-fixed-width icon-pencil"></i> Flatly</a></li>
                          <li><a href="#" class="change-style-menu-item" rel="CSS/bootswatch/bootstrap.journal.min.css"><i class="icon-fixed-width icon-pencil"></i> Journal</a></li>
                          <li><a href="#" class="change-style-menu-item" rel="CSS/bootswatch/bootstrap.lumen.min.css"><i class="icon-fixed-width icon-pencil"></i> Lumen</a></li>
                          <li><a href="#" class="change-style-menu-item" rel="CSS/bootswatch/bootstrap.simplex.min.css"><i class="icon-fixed-width icon-pencil"></i> Simplex</a></li>
                          <li><a href="#" class="change-style-menu-item" rel="CSS/bootswatch/bootstrap.spacelab.min.css"><i class="icon-fixed-width icon-pencil"></i> Spacelab</a></li>
                          <li><a href="#" class="change-style-menu-item" rel="CSS/bootswatch/bootstrap.united.min.css"><i class="icon-fixed-width icon-pencil"></i> United</a></li>
                          <li><a href="#" class="change-style-menu-item" rel="CSS/bootswatch/bootstrap.yeti.min.css"><i class="icon-fixed-width icon-pencil"></i> Yeti</a></li>
                          <li class="divider"></li>
                          <li role="presentation" class="dropdown-header">Dark Color Schemes</li>
                          <li><a href="#" class="change-style-menu-item" rel="CSS/bootswatch/bootstrap.cyborg.min.css"><i class="icon-fixed-width icon-pencil"></i> Cyborg</a></li>
                          <li><a href="#" class="change-style-menu-item" rel="CSS/bootswatch/bootstrap.slate.min.css"><i class="icon-fixed-width icon-pencil"></i> Slate</a></li>
                          <li><a href="#" class="change-style-menu-item" rel="CSS/bootswatch/bootstrap.superhero.min.css"><i class="icon-fixed-width icon-pencil"></i> Superhero</a></li>
                      </ul>
                    </li>
					
                </ul>
				<ul class="nav navbar-nav navbar-right">
				<li><a href="javascript://" class="btn-nav"><button data-bind="fadeToggle: model.canEdit()" type="button" class="btn btn-default" data-toggle="modal" data-target="#myModal">Adventure Map</button></a></li>
				<li><a href="javascript://"><input class="btn" id="chkEdit" type="checkbox" data-bind="bootstrapSwitchOn: canEdit"/></a></li>
				</ul>
            </div>
            <!--/.nav-collapse -->
        </div>
    </div>

    <div class="container">
		
		<div class="page is-hidden">
			<div  style="text-align:right; height:0px; overflow: visible;">
				<span data-bind="fadeToggle: model.canEdit()"><label style="margin-right:6px;" for="chkEditAdvanced">Advanced Mode:</label><input id="chkEditAdvanced" class="icontext" type="checkbox" data-bind="checked: editAdvanced"/></span>
			</div>
			
            <div class=" row-fluid title">
                <h2 data-bind="html: story().title, contentEditable: canEdit"></h2>
                <p class="lead" data-bind="html: story().titleSubtext, contentEditable: canEdit"></p>
            </div>
			
            <div class="well pagecontent">
				<div class="pagetext" data-bind="fadepage: stagePage">
                    <div id="dvHeightMatch">
                        <p class="editable-block" data-bind="contentEditable: canEdit, html: currentPage().pageText"></p>
                        <ul class="pager choices">
					<!-- ko foreach: currentPage().choices -->
                            <li data-bind="css: {disabled: !$root.meetsRequirements($data.requirements())}">
								<a href="javascript://" class="choice" data-bind="click: $root.choose, popover: '#popoverContent', visible: $root.meetsRequirements($data.requirements()) || isSecret()===false || $root.canEdit, css: {'pager-reqmet-secret': isSecret(), 'pager-reqmet': $data.requirements().length && $root.meetsRequirements($data.requirements()), 'is-editable': $root.canEdit() }">
									<i class="fa fa-angle-right"></i>
									<span class="icontext editable-inline choicetext" onclick="if (model.canEdit()){selectElementContents(this);}" data-bind="html: caption, contentEditable: $root.canEdit"></span>
								</a>
							</li>
					<!-- /ko -->
						</ul>
						
                        <!--<div class="row"><div class="col-md-4"><input type="text" placeholder="Enter some text" /> <i class="fa fa-pencil fa-fw"></i></div></div>-->
                    
					<div class="row pagecontrols">
						<div class="col-md-12">
						<a href="javascript://" class="pagecontrol btn btn-link btn-sm" data-bind="visible: story().canStepBack, click: $root.stepBack"><i class="fa fa-angle-double-left"></i> Go Back </a>
						<div class="btn-group pagecontrol" >
								<a id="lnkNewChoice" href="#" data-target="#" data-toggle="dropdown" class="pager-newchoice dropdown-toggle btn btn-primary btn-sm" data-bind="fadeToggle: model.canEdit()"><i class="fa fa-plus"></i><span class="icontext">New Choice</span></a>
								<ul class="dropdown-menu" role="menu" aria-labelledby="lnkNewChoice">
									<li class="dropdown-header">Links to</li>
									<li><a data-bind="click: newChoice" class="choicetrigger" href="#"><i class="fa fa-code-fork fa-fw"></i>New Page</a></li>
									<li><a href="#"><i class="fa fa-sign-in fa-fw"></i>Existing Page</a></li>
								</ul>
						</div>
						</div>
					</div>
					</div>
				</div>
            </div>
			
			

			<div class="row">
            <!-- ko foreach: story().labelGroups -->
                <div class="col-md-6">
                    <fieldset class="labelgroup">
                        <legend data-bind="text: name"></legend>
                <!-- ko foreach: labels -->
                        <a class="label label-warning btn-sm" href="#" data-bind="fadeToggle: $root.meetsRequirements($data.requirements())"><i data-bind="css: icon" class="fa fa-fw"></i> <span data-bind="text: typeof($root.getValue($data.variableName())) === 'boolean' ? $data.name() : $data.name() + ': ' + $root.getValue($data.variableName())"></span></a>&nbsp;
                <!-- /ko -->
                    </fieldset>
                </div>
            <!-- /ko -->
			</div>
        </div>
    </div>

    <!-- /.container -->

    <div id="popoverContent" class="is-hidden"> 
        <label title="The choice will not appear until all of the requirements are met.">
		<input type="checkbox" data-bind="checked: model.currentChoice().isSecret" />  Secret</label>
        <div class="row"></div>
		<div class="col-sm-6">
            <fieldset>
                <legend>Requirements</legend>
			<!-- ko foreach: model.currentChoice().requirements -->
					<p data-bind="text: variableName"></p> 
			<!-- /ko -->
		        <div><a href="javascript:alert('Not Implemented')"><i class="fa fa-plus-square-o fa-fw"></i><span class="icontext">Add Requirement</span></a></div>
		    </fieldset>
		</div>
		<div class="col-sm-6">
            <fieldset>
                <legend>Commands</legend>
			<!-- ko foreach: model.currentChoice().commands -->
					<p data-bind="text: variableName"></p>
			<!-- /ko -->
		        <div><a href="javascript:alert('Not Implemented')"><i class="fa fa-plus-square-o fa-fw"></i><span class="icontext">Add Command</span></a></div>
		    </fieldset>
		</div>
    </div>
    
	<div id="myModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="adventureMapLabel" aria-hidden="true">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
					<h4 class="modal-title" id="adventureMapLabel">Adventure Map</h4>
				</div>
				<div class="modal-body">
					<button class="btn btn-default btn-sm" data-bind="click: $('.tree .fa-minus-circle').parent().click();"><i class="fa fa-plus-circle"></i> Collapse All</button>
					<button class="btn btn-default btn-sm" data-bind="click: $('.tree .fa-plus-circle').parent().click();"><i class="fa fa-minus-circle"></i> Expand All</button>
					<div id="storytree" class="tree">
					<ul data-bind="template: { name: 'nodeTmpl', foreach: $root.story().pageTree().nodes }"></ul> <!-- need to go one level higher, put root into an array -->
						<script id="nodeTmpl" type="text/html">
							<li>
								<span><i class="fa fa-minus-circle"></i></span><a href="" data-bind="text: '  Page ' + id()"></a><a href="#"><i class="fa fa-trash-o icontext"></i></a><p class="icontext" style="display:inline;" data-bind="text: $root.story().pages()[$data.id()].pageText().substring(0,60) + '...'"></p>
								<ul data-bind="template: { name: 'nodeTmpl', foreach: nodes }"></ul>
							</li>
						</script>
					</div>
				</div>
				<!--<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
					<button type="button" class="btn btn-primary">Save changes</button>
				</div>-->
			</div>
		</div>
    </div>

    <!-- Import Libraries and Models
    ================================================== -->
    <script src="Scripts/jquery-2.1.0.min.js"></script>
	<script src="Scripts/knockout-3.0.0.js"></script>
	<script src="Scripts/knockout.mapping-latest.js"></script>
    <script src="Scripts/bootstrap.min.js"></script>
    <script src="Scripts/jquery.transit.min.js"></script>
    <script src="Scripts/bootstrap-switch.min.js"></script>

	<script src="Scripts/treeView.js"></script>
	
	<script src="Scripts/adventure/Adventure.js"></script>
	<script src="Scripts/adventure/EngineModel.js"></script>
	<script src="Scripts/adventure/BindingHandlers.js"></script>
	<script src="Scripts/adventure/Utilities.js"></script>
    <script type="text/javascript">
        $(function () {
            //$("#chkEdit").bootstrapSwitch({ onText: 'Edit', offText: 'Play', size: 'large' });
            var story = {};
            $.ajax({
                url: 'story.txt',
                dataType: 'text'
            }).done(function (data) {
                story = JSON.parse(data);
                model.story(new Adventure.Story(story));
				$('#storytree').treeView();
                $('.page').fadeIn();
            }).error(function(response) {
                alert('Error: story.txt could not be located.');
            });

            $('body').on('click', '.change-style-menu-item', function () {
                $('link[title="main"]').attr('href', $(this).attr('rel'));
            });
			
			$('body').on('click', function (e) {
				$('.choice').each(function () {
					if (!$(this).is(e.target) && $(this).has(e.target).length === 0 && $('.popover').has(e.target).length === 0 && !$(e.target).hasClass('choicetrigger')) {
						$(this).popover('hide');
					}
				});
			});
        });
        
		var model = new Adventure.EngineModel({
            title: '',
            titleSubtext: '',
            author: '',
            canStepBack: true,
			variables: {},
			labelGroups: [],
            pages: [{choices:[{}]}],
			pageTree: {id:0, nodes:[]}
        });
		ko.applyBindings(model);
		
		//temporary
		function exportStory() {
			window.open('data:text/json,' + ko.toJSON(ko.mapping.toJS(model.story)), '_blank');
		}
    </script>
	
</body>
</html>
